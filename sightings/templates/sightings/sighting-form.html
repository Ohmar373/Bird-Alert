{% extends "base.html" %}

{% block title %}Post Sighting - Bird Alert{% endblock %}

{% block content %}
<div style="max-width: 500px; margin: 0 auto;">
    <div class="card">
        <h3 style="margin-bottom: 1rem;">Log Sighting</h3>
        
        {% if lat and lng %}
        <p style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">üìç {{ lat | floatformat:4 }}, {{ lng | floatformat:4 }}</p>
        {% endif %}

        <form method="post" style="display: flex; flex-direction: column; gap: 1rem;">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}
            
            <div class="form-group" style="position: relative;">
                <label for="{{ form.bird_species.id_for_label }}" class="form-label">Bird *</label>
                {{ form.bird_species }}
                <div id="bird_suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e0ddd7; border-top: none; max-height: 200px; overflow-y: auto; display: none; z-index: 10;"></div>
                {% if form.bird_species.errors %}<div class="text-danger">{{ form.bird_species.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.weather_conditions.id_for_label }}" class="form-label">Weather</label>
                {{ form.weather_conditions }}
                {% if form.weather_conditions.errors %}<div class="text-danger">{{ form.weather_conditions.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.description.id_for_label }}" class="form-label">Notes</label>
                {{ form.description }}
                {% if form.description.errors %}<div class="text-danger">{{ form.description.errors }}</div>{% endif %}
            </div>

            {{ form.latitude }}
            {{ form.longitude }}

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.95rem;">Submit</button>
                <a href="{% url 'sightings:add_sighting' %}" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.95rem;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
    #bird_suggestions .suggestion-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    #bird_suggestions .suggestion-item:hover {
        background-color: #f5f5f5;
    }
    
    #bird_suggestions .suggestion-item .common-name {
        font-weight: 500;
        color: #333;
    }
    
    #bird_suggestions .suggestion-item .scientific-name {
        font-size: 0.85rem;
        color: #999;
        font-style: italic;
    }
</style>

<script>
    const birdInput = document.getElementById('bird_species_input');
    const suggestionBox = document.getElementById('bird_suggestions');
    let debounceTimer;

    birdInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();

        if (query.length < 1) {
            suggestionBox.style.display = 'none';
            return;
        }

        debounceTimer = setTimeout(() => {
            fetch(`/sightings/api/search-birds/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionBox.innerHTML = '';
                    
                    if (data.results.length === 0) {
                        suggestionBox.innerHTML = '<div style="padding: 0.75rem; color: #999;">No birds found</div>';
                        suggestionBox.style.display = 'block';
                        return;
                    }

                    data.results.forEach(bird => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerHTML = `
                            <div class="common-name">${bird.common_name}</div>
                            <div class="scientific-name">${bird.scientific_name}</div>
                        `;
                        
                        div.addEventListener('click', () => {
                            birdInput.value = bird.common_name;
                            suggestionBox.style.display = 'none';
                        });
                        
                        suggestionBox.appendChild(div);
                    });
                    
                    suggestionBox.style.display = 'block';
                });
        }, 300);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== birdInput) {
            suggestionBox.style.display = 'none';
        }
    });

    // Show suggestions again when focusing input
    birdInput.addEventListener('focus', function() {
        if (this.value.trim().length > 0 && suggestionBox.innerHTML !== '') {
            suggestionBox.style.display = 'block';
        }
    });
</script>
{% endblock %}